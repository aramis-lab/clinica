#!/usr/bin/env groovy

// Continuous Integration script to build mkdocs in Docker
// Author: mauricio.diaz@inria.fr

pipeline {
    agent none
    stages {
        stage('Build the docs') {
      agent {
        label 'ubuntu'
      }
      environment {
        CONDA_ENV = "$WORKSPACE/env"
        CONDA_HOME = "$HOME/miniconda3"
        PATH = "$HOME/.local/bin:$PATH"
      }
      steps {
        sh '''
                source "${CONDA_HOME}/etc/profile.d/conda.sh"
                conda create -y -p "${CONDA_ENV}" python=3.9
                conda activate "${CONDA_ENV}"
                make doc
                '''
        stash(name: 'doc_html', includes: 'site/**')
      }
      post {
        always {
          cleanWs()
        }
      }
        }
        stage('Deploy') {
      agent { label 'ubuntu' }
      steps {
        echo 'Deploying in webserver...'
        sh 'echo "Agent name: ${NODE_NAME}"'
        sh 'echo "My branch name is ${BRANCH_NAME}"'
        unstash(name: 'doc_html')
        sh 'mv site "${CHANGE_ID:-$BRANCH_NAME}"'
        sshPublisher(
              publishers: [
                sshPublisherDesc(
                  configName: 'web',
                  transfers: [
                    sshTransfer(
                      cleanRemote: false,
                      excludes: '',
                      execCommand: '',
                      execTimeout: 120000,
                      flatten: false,
                      makeEmptyDirs: false,
                      noDefaultExcludes: false,
                      patternSeparator: '[, ]+',
                      remoteDirectory: 'clinica/docs/public/',
                      remoteDirectorySDF: false,
                      removePrefix: '',
                      sourceFiles: "${CHANGE_ID:-$BRANCH_NAME}/**"
                    )
                  ],
                  usePromotionTimestamp: false,
                  useWorkspaceInPromotion: false,
                  verbose: false
                )
              ]
            )
        echo 'Finish uploading artifacts'
      }
        }
    }
    post {
        failure {
      mail to: 'clinica-ci@inria.fr',
          subject: "The build of the Clinica's user documentatio has failed: ${currentBuild.fullDisplayName}",
          body: "Something is wrong with the build of the welcome guide ${env.BUILD_URL}"
        }
    }
}
